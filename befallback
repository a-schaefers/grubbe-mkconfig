#!/bin/sh

FALLBACK="$(/sbin/zfs list -H -d 2 -o type,name,canmount,mountpoint | \
  awk 'BEGIN  { FS="\t"; split("",mounts); }; ( $1 ~ /filesystem/ ) && \
  ( $2 ~ /ROOT\// ) && \
  ( $4 == "/" || $4 == "none") \
  { mounts[$2]=$0; }; END { for (m in mounts) { gsub(/.*\//, "", m); print m; }; };' | \
    sort | \
    grep 'fallback')"
if [ "$FALLBACK" == "" ] ;
then
  # create fallback if it doesn't exist already
  /usr/local/sbin/beadm create fallback
else
  # otherwise destroy fallback and recreate it
yes | /usr/local/sbin/beadm destroy fallback &&
/usr/local/sbin/beadm create fallback
fi

# update boot loader
/usr/local/sbin/grubbe-mkconfig > /boot/grub/grub.cfg

