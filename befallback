#!/bin/bash

# create fallback if it doesn't exist already
FALLBACK="$(/sbin/zfs list -H -d 2 -o type,name,canmount,mountpoint | \
  awk 'BEGIN  { FS="\t"; split("",mounts); }; ( $1 ~ /filesystem/ ) && \
  ( $2 ~ /ROOT\// ) && \
  ( $4 == "/" || $4 == "none") \
  { mounts[$2]=$0; }; END { for (m in mounts) { gsub(/.*\//, "", m); print m; }; };' | \
    sort | \
    grep 'fallback')"
if [ "$FALLBACK" == "" ] ;
then
  /usr/local/sbin/beadm create fallback
  exit
fi

# destroy and recreate fallback
yes | /usr/local/sbin/beadm destroy fallback &&
/usr/local/sbin/beadm create fallback

